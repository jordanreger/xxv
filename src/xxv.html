<!DOCTYPE html>
<html lang="en">
  <head>

    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=5, shrink-to-fit=no"
    />
    <meta
      name="theme-color"
      content="#000"
    />

    <title>xxv</title>


    <!-- PWA -->

    <link rel="manifest" href="/manifest.webmanifest" />

    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function() {
          navigator.serviceWorker
            .register("/service-worker.js")
            .catch(err => console.log("service worker not registered", err))
        })
      }
    </script>

    <!-- PWA -->

    <link rel="apple-touch-icon" sizes="500x500" href="/xxvlogo.png" />
    <link rel="shortcut icon" href="/xxvlogo.png" />

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&family=Space+Grotesk:wght@300;400;500&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&family=Space+Grotesk:wght@300;400;500&display=swap" media="print" onload="this.media='all'" />
    <noscript>
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&family=Space+Grotesk:wght@300;400;500&display=swap" />
    </noscript>

    <style>
      html {
        background-color: #000;
      }
    </style>

    <link rel="stylesheet" href="/main.css" async />

  </head>
  <script name="setup">
    function hfs(size) {
      var i = Math.floor( Math.log(size) / Math.log(1024) );
      return ( size / Math.pow(1024, i) ).toFixed(2) * 1 + ['b', 'kb', 'mb'][i];
    };
    if ('storage' in navigator && 'estimate' in navigator.storage) {
      navigator.storage.estimate().then(estimate => {
        console.log(`app size: ${hfs(estimate.usage)}`);
      });
    }

    window.addEventListener('DOMContentLoaded', function() {
      window.resizeTo(475, 600);
    }, true);
  </script>
  <script name="importBar" type="module">
    import {LitElement, html, css} from "https://esm.sh/lit";

    class importBar extends LitElement {
      static styles = css`
        ::-moz-selection {
          color: #000;
          background: #ffcf96;
        }

        ::selection {
          color: #000;
          background: #ffcf96;
        }

        input {
          border: none;
          outline: 2px solid #c4c4c4;
          background-color: transparent;
          position: absolute;
          width: 100%;
          height: 100%;
          border-radius: 10px;
          color: #c4c4c4;
          font-family: IBM Plex Mono;
          box-sizing: border-box;
          padding-left: 3vmin;
          font-size: 4vmin;
        }
      `;

      async handleSubmit(e){
        e.preventDefault();
        let input = this.shadowRoot.children[0].children[0], mod = input.value;
        if(mod) {
          let data = await fetch(`https://raw.githubusercontent.com/xxvnetwork/modules/main/${mod}.html`)
            .then((data) => data.arrayBuffer())
            .then((data) => { return data })
          data = encodeURIComponent(btoa(String.fromCharCode(...new Uint8Array(data))));
          if ("serviceWorker" in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
              for(let registration of registrations) {
                registration.unregister()
              }}).then(() => {
                caches.open('xxv.network').then(cache => {
                  cache.add(`/module?data=${data}`);
                })
                localStorage.setItem(mod, data);
                input.value = "";
                location.reload();
              })
          }
        } else {
          console.log("please input a valid module name");
        }

      }

      render() {
        return html`${navigator.onLine ?
          html`
            <form @submit="${(e) => this.handleSubmit(e)}">
              <input type="text" placeholder="module" name="modules" list="commonmods" />
              <datalist id="commonmods">
                <option value="base">
                <option value="about">
              </datalist>
            </form>
            <br/>
          `: null}`;
      }
    }
    customElements.get("import-bar") || customElements.define("import-bar", importBar);
  </script>

  <script name="moduleBox" type="module">
    import {LitElement, html, css} from "https://esm.sh/lit";

    class moduleBox extends LitElement {
      static styles = css`
        .modules {
          padding: 3vmin;
          user-select: none;
        }

        ::-webkit-scrollbar {
            width: 0;
        }

        .arrow {
          display: inline-block;
          font-family: IBM Plex Mono;
          font-size: 4vmin;
          -moz-transform: scale(-1, 1);
          -webkit-transform: scale(-1, 1);
          transform: scale(-1, 1);
          user-select: none;
          color: #696969;
        }

        .module-name {
          font-family: IBM Plex Mono;
          font-weight: bold;
          font-size: 5vmin;
          user-select: none;
          color: #e0e0e0;
        }

        .module-name:hover {
          color: #ffcf96;
          cursor: pointer;
        }

        .module-description {
          font-family: IBM Plex Mono;
          font-size: 4vmin;
          user-select: none;
          color: #c4c4c4;
        }
      `;

      spawnApp(mod){
        window.open(`/module?data=${localStorage.getItem(mod)}`, "test", "popup,noopener");
      }

      render() {
        let modulesList = [];
        for(let i = 0; i < window.localStorage.length; i++){
          modulesList.push(html`<div class="module"><span class="arrow">â†µ</span> <span class="module-name" @click=${() => { this.spawnApp(Object.keys(window.localStorage)[i])}}>${Object.keys(window.localStorage)[i]}</span><span class="module-description"></span></div>`);
        }
        return html`
          <div class="modules">
            ${modulesList}
          </div>
        `;
      }
    }
    customElements.get("modules-box") || customElements.define("modules-box", moduleBox);
  </script>

  <main id="app">
    <div class="import-title">Import</div>
    <import-bar class="import-bar"></import-bar>
    <div class="modules-title">Modules</div>
    <modules-box class="modules-box"></modules-box>
    <!--<button onClick="unregisterSW()">unregister</button>-->
    <script>
      function unregisterSW(){
        navigator.serviceWorker.getRegistrations().then( function(registrations) { for(let registration of registrations) { registration.unregister(); } })
      }
    </script>
  </main>
</html>
