<!DOCTYPE html>
<html lang="en">
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=5, shrink-to-fit=no"
    />
  </head>
  <body>
    <script name="pkgSearchBar" type="module">
      import {LitElement, html, css} from "https://esm.sh/lit";

      class pkgSearchBar extends LitElement {
        async handleSubmit(e){
          e.preventDefault();
          let input = this.shadowRoot.children[0].children[0], url = input.value, main = this.parentElement;
          if(url) {
            let resText = await fetch(`https://jrcors.herokuapp.com/${url}`)
              .then((data) => data.json())
              .then((data) => { return JSON.stringify(data, null, 2) })
            let res = await fetch(`https://jrcors.herokuapp.com/${url}`)
              .then((data) => data.json())
              .then((data) => { return data })
            let js = await fetch(`https://jrcors.herokuapp.com/${res.url}`)
              .then((data) => data.text())
              .then((data) => { return data })

            main.children[0].innerText = resText;
            localStorage.setItem(`${res.pkg}`, `${js}`);
            /*const newDiv = document.createElement("test-element");
            main.appendChild(newDiv);*/
            input.value = "";
          } else {
            console.log("please input a valid package url")
          }

        }

        render() {
          return html`
          <form @submit="${(e) => this.handleSubmit(e)}">
            <input type="url" placeholder="/pkg" name="pkg" list="commonpkgs" />
            <datalist id="commonpkgs">
              <option value="https://jordanreger.com/robots.txt">
              <option value="https://xxv.network/test">
            </datalist>
          </form>
          `;
        }
      }
      customElements.get("pkg-searchbar") || customElements.define("pkg-searchbar", pkgSearchBar);
    </script>

    <script name="pkgList" type="module">
      import {LitElement, html, css} from "https://esm.sh/lit";

      class pkgList extends LitElement {
        render() {
          let pkgList = [];
          for(let i = 0; i < window.localStorage.length; i++){
            pkgList.push(html`<pre style="word-wrap: break-word; white-space: pre-wrap" @click="${() => { let main = this.parentElement; main.children[0].innerText = window.localStorage[Object.keys(window.localStorage)[i]]; }}">â€” ${Object.keys(window.localStorage)[i]}</pre>`);
          }
          return html`
            <ul>
              ${pkgList}
            </ul>
          `;
        }
      }
      customElements.get("pkg-list") || customElements.define("pkg-list", pkgList);
    </script>

    <main id="app">
      <pre style="word-wrap: break-word; white-space: pre-wrap">xxv.package</pre>
      <pkg-searchbar></pkg-searchbar>
      <pkg-list></pkg-list>
    </main>
  </body>
</html>
